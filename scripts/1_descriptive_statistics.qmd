---
title: "Dosage Descriptive Statistics and Modelling"
format: html
editor: visual
---

```{r, include = FALSE}
library(tidyverse)
library(patchwork)
```

## Reading Data

```{r}
data_bup <- readRDS(here::here("data/processed/data_bup.rds")) 

data_met <- readRDS(here::here("data/processed/data_met.rds"))
```

## Descriptive Stats Stratified by Race and Week

### bup dose in long format for summary statistics

```{r}
data_bup_long <- data_bup |>
    pivot_longer(
    cols = starts_with("wk"),
    names_to = c("week", "type_name"),
    names_pattern = "(wk[0-9]+).?(.*)",
    values_to = "count") |>
    pivot_wider(id_cols = c("who", "xrace", "week", "site"),
                names_from = "type_name",
                values_from = "count") |>
    mutate(dose_this_week = case_when(
        censor == 0 ~ as.numeric(NA),
        TRUE ~ dose_this_week),
        week = as.integer(gsub("^.{0,2}", "", week))) |>
    mutate(dose_this_week = ifelse(censor == 0, as.numeric(NA), dose_this_week))

# calculating median + iqr
data_bup_long |>
    filter(is.na(dose_this_week) == FALSE) |>
    filter(censor == 1) |>
    summarize(mean = median(dose_this_week),
              iqr = quantile(dose_this_week, c(0.25, 0.75)))

data_bup_long_grouped <- data_bup_long |>
        group_by(week, xrace) |>
        summarize(avg = mean(dose_this_week, na.rm = TRUE),
                  sd = sd(dose_this_week, na.rm = TRUE),
                  se = plotrix::std.error(dose_this_week, na.rm = TRUE),
                  low = avg - 1.96*se,
                  high = avg + 1.96*se,
                  count = n(),
                  uncensored = sum(censor), #summing uncensored individuals
                  censored = n() - sum(censor), #summing censored individuals
                  max = max(dose_this_week, na.rm = TRUE),
                  min = min(dose_this_week, na.rm = TRUE),
                  range_bup = max - min) |>
    mutate(xrace = case_when(xrace == "1" ~ "White",
                             xrace == "2" ~ "Black",
                             xrace == "3" ~ "Hispanic")) |>
    filter(week <= 4)
```

### met dose in long format for summary statistics

```{r}
data_met_long <- data_met |>
    pivot_longer(
    cols = starts_with("wk"),
    names_to = c("week", "type_name"),
    names_pattern = "(wk[0-9]+).?(.*)",
    values_to = "count") |>
    pivot_wider(id_cols = c("who", "xrace", "week", "site"),
                names_from = "type_name",
                values_from = "count") |>
    mutate(dose_this_week = case_when(
        censor == 0 ~ as.numeric(NA),
        TRUE ~ dose_this_week),
        week = as.integer(gsub("^.{0,2}", "", week))) |>
    mutate(dose_this_week = ifelse(censor == 0, as.numeric(NA), dose_this_week))

# calculating median + iqr
data_met_long |>
    filter(is.na(dose_this_week) == FALSE) |>
    filter(censor == 1) |>
    summarize(mean = median(dose_this_week),
              iqr = quantile(dose_this_week, c(0.25, 0.75)),
              max = max(dose_this_week), 
              min = min(dose_this_week))

data_met_long_grouped <- data_met_long |>
    group_by(week, xrace) |>
        summarize(avg = mean(dose_this_week, na.rm = TRUE),
                  sd = sd(dose_this_week, na.rm = TRUE),
                  se = plotrix::std.error(dose_this_week, na.rm = TRUE),
                  low = avg - 1.96*se,
                  high = avg + 1.96*se,
                  count = n(),
                  uncensored = sum(censor), #summing uncensored individuals
                  censored = n() - sum(censor), #summing censored individuals
                  max = max(dose_this_week, na.rm = TRUE),
                  min = min(dose_this_week, na.rm = TRUE),
                  range_bup = max - min) |>
    mutate(xrace = case_when(xrace == "1" ~ "White",
                             xrace == "2" ~ "Black",
                             xrace == "3" ~ "Hispanic")) |>
    filter(week <= 4)
```

```{r}
# unadjusted binomial
bup_binom_df <- data_bup |>
    group_by(xrace) |>
    summarize(wk3.binary_prop = 
                  sum(
                      ifelse((wk3.binary == 1 & wk3.censor == 1), 1, 0))/sum(wk3.censor == 1),
              wk4.binary_prop = 
                  sum(
                      ifelse((wk4.binary == 1 & wk4.censor == 1), 1, 0))/sum(wk4.censor == 1)) |>
    mutate(xrace = case_when(xrace == "1" ~ "White",
                    xrace == "2" ~ "Black",
                    xrace == "3" ~ "Hispanic")) |>
    pivot_longer(cols = wk3.binary_prop:wk4.binary_prop,
                 names_to = "week",
                 values_to = c("prop")) |>
    mutate(week = ifelse(week == "wk3.binary_prop", 3, 4)) |>
    left_join(data_bup |>
    group_by(xrace) |>
    summarize(wk3.n = sum(wk3.censor == 1),
              wk4.n = sum(wk4.censor == 1)) |>
    mutate(xrace = case_when(xrace == "1" ~ "White",
                    xrace == "2" ~ "Black",
                    xrace == "3" ~ "Hispanic")) |>
    pivot_longer(cols = wk3.n:wk4.n,
                 names_to = "week",
                 values_to = c("n")) |>
        mutate(week = ifelse(week == "wk3.n", 3, 4)), by = c("xrace" = "xrace", "week" = "week")) |>
    mutate(se = sqrt((prop * (1-prop))/n),
           lower = prop - 1.96*se,
           upper = prop + 1.96*se)

met_binom_df <- data_met |>
    group_by(xrace) |>
    summarize(wk3.binary_prop = 
                  sum(
                      ifelse((wk3.binary == 1 & wk3.censor == 1), 1, 0))/sum(wk3.censor == 1),
              wk4.binary_prop = 
                  sum(
                      ifelse((wk4.binary == 1 & wk4.censor == 1), 1, 0))/sum(wk4.censor == 1)) |>
    mutate(xrace = case_when(xrace == "1" ~ "White",
                    xrace == "2" ~ "Black",
                    xrace == "3" ~ "Hispanic")) |>
    pivot_longer(cols = wk3.binary_prop:wk4.binary_prop,
                 names_to = "week",
                 values_to = c("prop")) |>
    mutate(week = ifelse(week == "wk3.binary_prop", 3, 4)) |>
    left_join(data_met |>
    group_by(xrace) |>
    summarize(wk3.n = sum(wk3.censor == 1),
              wk4.n = sum(wk4.censor == 1)) |>
    mutate(xrace = case_when(xrace == "1" ~ "White",
                    xrace == "2" ~ "Black",
                    xrace == "3" ~ "Hispanic")) |>
    pivot_longer(cols = wk3.n:wk4.n,
                 names_to = "week",
                 values_to = c("n")) |>
        mutate(week = ifelse(week == "wk3.n", 3, 4)), by = c("xrace" = "xrace", "week" = "week")) |>
    mutate(se = sqrt((prop * (1-prop))/n),
           lower = prop - 1.96*se,
           upper = prop + 1.96*se)
```

```{r}
data_comb <- data_bup |>
    merge(data_met, all = TRUE)

comb_binom_df <- data_comb |>
    group_by(xrace) |>
    summarize(wk3.binary_prop = 
                  sum(
                      ifelse((wk3.binary == 1 & wk3.censor == 1), 1, 0))/sum(wk3.censor == 1),
              wk4.binary_prop = 
                  sum(
                      ifelse((wk4.binary == 1 & wk4.censor == 1), 1, 0))/sum(wk4.censor == 1)) |>
    mutate(xrace = case_when(xrace == "1" ~ "White",
                             xrace == "2" ~ "Black",
                             xrace == "3" ~ "Hispanic")) |>
    pivot_longer(cols = wk3.binary_prop:wk4.binary_prop,
                 names_to = "week",
                 values_to = c("prop")) |>
    mutate(week = ifelse(week == "wk3.binary_prop", 3, 4)) |>
    left_join(data_comb |>
                  group_by(xrace) |>
                  summarize(wk3.n = sum(wk3.censor == 1),
                            wk4.n = sum(wk4.censor == 1)) |>
                  mutate(xrace = case_when(xrace == "1" ~ "White",
                                           xrace == "2" ~ "Black",
                                           xrace == "3" ~ "Hispanic")) |>
                  pivot_longer(cols = wk3.n:wk4.n,
                               names_to = "week",
                               values_to = c("n")) |>
                  mutate(week = ifelse(week == "wk3.n", 3, 4)), by = c("xrace" = "xrace", "week" = "week")) |>
    mutate(se = sqrt((prop * (1-prop))/n),
           lower = prop - 1.96*se,
           upper = prop + 1.96*se)
```

## Sites

```{r}
## Site

bup_sites <- data_bup_long |>
    filter(week <= 4 & censor == 1) |> #filtering out censoring
    group_by(site, week, xrace) |>
    summarize(count = n(), mean_dose = mean(dose_this_week)) |>
    mutate(freq = count/sum(count))

met_sites <- data_met_long |>
    filter(week <= 4 & censor == 1) |> #filtering out censoring
    group_by(site, week, xrace) |>
    summarize(count = n(), mean_dose = mean(dose_this_week)) |>
    mutate(freq = count/sum(count))
```

## Saving Results

```{r}
#saveRDS(data_bup_long, here::here("data/processed/data_bup_long_ungrouped.rds"))
#saveRDS(data_met_long, here::here("data/processed/data_met_long_ungrouped.rds"))
#saveRDS(data_bup_long_grouped, here::here("data/processed/data_bup_long.rds"))
#saveRDS(data_met_long_grouped, here::here("data/processed/data_met_long.rds"))
#saveRDS(bup_sites, here::here("data/processed/bup_sites.rds"))
#saveRDS(met_sites, here::here("data/processed/met_sites.rds"))
#saveRDS(bup_binom_df, here::here("data/processed/bup_binom_df.rds"))
#saveRDS(met_binom_df, here::here("data/processed/met_binom_df.rds"))
#saveRDS(comb_binom_df, here::here("data/processed/comb_binom_df.rds"))
```
