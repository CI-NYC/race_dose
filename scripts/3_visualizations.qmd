---
title: "Dosage Descriptive Statistics and Modelling"
format: html
editor: visual
---

```{r, include = FALSE}
library(tidyverse)
library(ggplot2)
library(lmtp)
library(SuperLearner)
#library(parallel)
```

## Reading/Storing Results

```{r}
data_bup_long <- readRDS(here::here("data/processed/data_bup_long.rds"))

data_met_long <- readRDS(here::here("data/processed/data_met_long.rds"))

met_results_all <- data.frame(week = integer(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

met_results_lim <- data.frame(week = integer(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

bup_results_all <- data.frame(week = integer(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

bup_results_lim <- data.frame(week = integer(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

# Loop through the file paths and read the RDS files into data frames
for (j in 1:3)
{
met_results_all_temp <- data.frame(week = numeric(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

met_results_lim_temp <- data.frame(week = numeric(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

bup_results_all_temp <- data.frame(week = numeric(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

bup_results_lim_temp <- data.frame(week = numeric(0), race = numeric(0), theta = numeric(0), se = numeric(0), lower = numeric(0), upper = numeric(0))

for (i in 1:4) {
  data_met <- readRDS(here::here(paste0("./data/102623/met/","result_met", j, sep = "_", i, ".rds")))
  met_results_all_temp[[i, "week"]] <- i
  met_results_all_temp[[i, "race"]] <- j
  met_results_all_temp[[i, "theta"]] <- data_met$theta
  met_results_all_temp[[i, "se"]] <- data_met$standard_error
  met_results_all_temp[[i, "lower"]] <- data_met$low
  met_results_all_temp[[i, "upper"]] <- data_met$high
  
  data_met_lim <- readRDS(here::here(paste0("./data/102623/met/","result_met_limited", j, sep = "_", i, ".rds")))
  met_results_lim_temp[[i, "week"]] <- i
  met_results_lim_temp[[i, "race"]] <- j
  met_results_lim_temp[[i, "theta"]] <- data_met_lim$theta
  met_results_lim_temp[[i, "se"]] <- data_met_lim$standard_error
  met_results_lim_temp[[i, "lower"]] <- data_met_lim$low
  met_results_lim_temp[[i, "upper"]] <- data_met_lim$high
 
  data_bup <- readRDS(here::here(paste0("./data/102623/bup/","result", j, sep = "_", i, ".rds")))
  bup_results_all_temp[[i, "week"]] <- i
  bup_results_all_temp[[i, "race"]] <- j
  bup_results_all_temp[[i, "theta"]] <- data_bup$theta
  bup_results_all_temp[[i, "se"]] <- data_bup$standard_error
  bup_results_all_temp[[i, "lower"]] <- data_bup$low
  bup_results_all_temp[[i, "upper"]] <- data_bup$high
  
  data_bup_lim <- readRDS(here::here(paste0("./data/102623/bup/","result_limited", j, sep = "_", i, ".rds")))
  bup_results_lim_temp[[i, "week"]] <- i
  bup_results_lim_temp[[i, "race"]] <- j
  bup_results_lim_temp[[i, "theta"]] <- data_bup_lim$theta
  bup_results_lim_temp[[i, "se"]] <- data_bup_lim$standard_error
  bup_results_lim_temp[[i, "lower"]] <- data_bup_lim$low
  bup_results_lim_temp[[i, "upper"]] <- data_bup_lim$high
}

met_results_all <- met_results_all |>
    merge(met_results_all_temp, all = TRUE)

met_results_lim <- met_results_lim |>
    merge(met_results_lim_temp, all = TRUE) 

bup_results_all <- bup_results_all |>
    merge(bup_results_all_temp, all = TRUE)

bup_results_lim <- bup_results_lim |>
    merge(bup_results_lim_temp, all = TRUE)
}

met_results_all <- met_results_all |>
    mutate(race = as.factor(race)) |>
    mutate(race = case_when(race == "1" ~ "White",
                             race == "2" ~ "Black",
                             race == "3" ~ "Hispanic"))

met_results_lim <- met_results_lim |>
    mutate(race = as.factor(race)) |>
    mutate(race = case_when(race == "1" ~ "White",
                             race == "2" ~ "Black",
                             race == "3" ~ "Hispanic"))

bup_results_all <- bup_results_all |>
    mutate(race = as.factor(race)) |>
    mutate(race = case_when(race == "1" ~ "White",
                             race == "2" ~ "Black",
                             race == "3" ~ "Hispanic"))

bup_results_lim <- bup_results_lim |>
    mutate(race = as.factor(race)) |>
    mutate(race = case_when(race == "1" ~ "White",
                             race == "2" ~ "Black",
                             race == "3" ~ "Hispanic"))
```

## Plotting Results

### Unadjusted

```{r}
custom_colors <- c("White" = "#e31a1c", "Black" = "#1f78b4", "Hispanic" = "darkseagreen4")

ggplot(data_bup_long, aes(x = week, y = avg_bup, group = xrace, color = xrace)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = low, ymax = high), width = 0.2) +
  labs(title = "Mean Buprenorphine Dose by Race Over Time (Unadjusted)",
       x = "Week",
       y = "Mean Dose") +
  scale_color_manual(values = custom_colors) +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
  theme_minimal() + 
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race")

ggplot(data_bup_long, aes(x = week, y = avg_bup, color = xrace)) +
  geom_line() +   # Connect means with lines
  geom_ribbon(aes(ymin = low, ymax = high, fill = xrace), alpha = 0.3) + 
  labs(title = "Mean Buprenorphine Dose by Race Over Time (Unadjusted)",
       x = "Week",
       y = "Mean Dose",
       color = "Group") +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
      scale_color_manual(values = custom_colors) + 
  scale_fill_manual(values = custom_colors) +  
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race", 
         fill = "Race")

ggplot(data_met_long, aes(x = week, y = avg_met, group = xrace, color = xrace)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = low, ymax = high), width = 0.2) +
  labs(title = "Mean Methadone Dose by Race Over Time (Unadjusted)",
       x = "Week",
       y = "Mean Dose") +
  scale_color_manual(values = custom_colors) +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
  theme_minimal() + 
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race")

ggplot(data_met_long, aes(x = week, y = avg_met, color = xrace)) +
  geom_line() +   # Connect means with lines
  geom_ribbon(aes(ymin = low, ymax = high, fill = xrace), alpha = 0.3) + 
  labs(title = "Mean Methadone Dose by Race Over Time (Unadjusted)",
       x = "Week",
       y = "Mean Dose",
       color = "Group") +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
      scale_color_manual(values = custom_colors) + 
  scale_fill_manual(values = custom_colors) +  
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race", 
         fill = "Race")
```

### Adjusted -- Sex + Age

```{r}
custom_colors <- c("White" = "#e31a1c", "Black" = "#1f78b4", "Hispanic" = "darkseagreen4") # color scheme, can adjust

## sex and age

ggplot(bup_results_lim, aes(x = week, y = theta, group = race, color = race)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(title = "Mean Buprenorphine Dose by Race Over Time (Adjusted, Sex + Age)",
       x = "Week",
       y = "Mean Dose") +
  scale_color_manual(values = custom_colors) +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
  theme_minimal() + 
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race")

ggplot(bup_results_lim, aes(x = week, y = theta, color = race)) +
  geom_line() +   # Connect means with lines
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = race), alpha = 0.3) + 
  labs(title = "Mean Buprenorphine Dose by Race Over Time (Adjusted, Sex + Age)",
       x = "Week",
       y = "Mean Dose",
       color = "Group") +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
      scale_color_manual(values = custom_colors) + 
  scale_fill_manual(values = custom_colors) +  
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race", 
         fill = "Race")

ggplot(met_results_lim, aes(x = week, y = theta, group = race, color = race)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(title = "Mean Methadone Dose by Race Over Time (Adjusted, Sex + Age)",
       x = "Week",
       y = "Mean Dose") +
  scale_color_manual(values = custom_colors) +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
  theme_minimal() + 
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race")

ggplot(met_results_lim, aes(x = week, y = theta, color = race)) +
  geom_line() +   # Connect means with lines
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = race), alpha = 0.3) + 
  labs(title = "Mean Methadone Dose by Race Over Time (Adjusted, Sex + Age)",
       x = "Week",
       y = "Mean Dose",
       color = "Group") +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
      scale_color_manual(values = custom_colors) + 
  scale_fill_manual(values = custom_colors) +  
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race", 
         fill = "Race")
```

### Adjusted -- Expanded Covariates

```{r}
ggplot(bup_results_all, aes(x = week, y = theta, group = race, color = race)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(title = "Mean Buprenorphine Dose by Race Over Time (Adjusted, Expanded Covariates)",
       x = "Week",
       y = "Mean Dose") +
  scale_color_manual(values = custom_colors) +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
  theme_minimal() + 
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race")

ggplot(bup_results_all, aes(x = week, y = theta, color = race)) +
  geom_line() +   # Connect means with lines
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = race), alpha = 0.3) + 
  labs(title = "Mean Buprenorphine Dose by Race Over Time (Adjusted, Expanded Covariates)",
       x = "Week",
       y = "Mean Dose",
       color = "Group") +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
      scale_color_manual(values = custom_colors) + 
  scale_fill_manual(values = custom_colors) +  
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race", 
         fill = "Race")

ggplot(met_results_all, aes(x = week, y = theta, group = race, color = race)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(title = "Mean Methadone Dose by Race Over Time (Adjusted, Expanded Covariates)",
       x = "Week",
       y = "Mean Dose") +
  scale_color_manual(values = custom_colors) +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
  theme_minimal() + 
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race")

ggplot(met_results_all, aes(x = week, y = theta, color = race)) +
  geom_line() +   # Connect means with lines
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = race), alpha = 0.3) + 
  labs(title = "Mean Methadone Dose by Race Over Time (Adjusted, Expanded Covariates)",
       x = "Week",
       y = "Mean Dose",
       color = "Group") +
    scale_x_continuous(breaks = seq(1, 4, by = 1)) +
      scale_color_manual(values = custom_colors) + 
  scale_fill_manual(values = custom_colors) +  
  theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, vjust = 0.5)) + 
    labs(color = "Race", 
         fill = "Race")
```
